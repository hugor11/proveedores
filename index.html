<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Proveedores - Abarrotes y Carnicería Itzel</title>
    <meta name="description" content="Sistema de gestión de proveedores para Abarrotes y Carnicería Itzel">
    <style>
        /* Estilos Generales */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: #f8f9fa; 
            color: #212529; 
            line-height: 1.5;
        }
        header { 
            background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%); 
            color: #ff4757; 
            text-align: center; 
            padding: 1.5rem 0; 
            border-bottom: 3px solid #ff4757; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        header h1 { 
            margin: 0; 
            font-size: 2.2em; 
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .main-container { 
            width: 90%; 
            max-width: 1200px; 
            margin: 20px auto; 
        }
        .seccion { 
            background-color: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        .seccion h2 { 
            text-align: center; 
            color: #dc3545; 
            margin-bottom: 30px; 
            margin-top: 5px; 
            border-bottom: 2px solid #dc3545; 
            padding-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #495057; 
            font-weight: 600; 
            font-size: 0.95em;
        }
        input[type="text"], input[type="date"], select, textarea { 
            width: 100%; 
            padding: 12px 15px; 
            margin-bottom: 20px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-family: inherit; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        textarea { 
            resize: vertical; 
            min-height: 100px; 
        }
        button { 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.95rem; 
            font-weight: 600;
            transition: all 0.3s ease; 
            margin-right: 8px; 
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        #navegacion button, #proveedor-form button[type="submit"] { background-color: #dc3545; }
        #navegacion button:hover, #proveedor-form button[type="submit"]:hover { background-color: #c82333; }
        #botonesReportesPredefinidos button, #btnGenerarReportePersonalizado { background-color: #007bff; }
        #botonesReportesPredefinidos button:hover, #btnGenerarReportePersonalizado:hover { background-color: #0056b3; }
        #btnExportarDatos { background-color: #28a745; }
        #btnExportarDatos:hover { background-color: #218838; }
        #btnImportarDatos { background-color: #ffc107; color: #212529; }
        #btnImportarDatos:hover { background-color: #e0a800; }
        .btn-eliminar-proveedor { background-color: #6c757d; padding: 5px 10px; font-size: 0.8rem; }
        .btn-eliminar-proveedor:hover { background-color: #5a6268; }
        .btn-editar-proveedor { background-color: #17a2b8; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;}
        .btn-editar-proveedor:hover { background-color: #138496;}
        #btnExportarReporteCSV { background-color: #17a2b8; margin-top: 15px;}
        #btnExportarReporteCSV:hover { background-color: #138496;}
        table { border-collapse: collapse; margin-top: 20px; width: 100%; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: left; vertical-align: middle; font-size: 0.9em; }
        th { background-color: #e9ecef; font-weight: 600; }
        #tablaReporte { margin-top: 20px; overflow-x: auto; }
        #tablaReporte th, #tablaReporte td { text-align: center; }
        #tablaReporte th:first-child, #tablaReporte td:first-child { text-align: left; }
        .asistencia-container { display: flex; align-items: center; gap: 8px; justify-content: center; }
        .asistencia-container span { min-width: 25px; display: inline-block; text-align: left; vertical-align: middle; }
        
        /* Estilos para entrega automática */
        .entrega-automatica {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }
        .entrega-automatica td {
            position: relative;
        }
        .icono-preventa::before {
            content: "🛒 ";
            margin-right: 5px;
        }
        .icono-entrega::before {
            content: "📦 ";
            margin-right: 5px;
        }
        .tag-programada {
            font-size: 0.75em;
            color: #856404;
            font-weight: 500;
            background-color: #fff3cd;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .tooltip-entrega {
            position: relative;
        }
        .tooltip-entrega:hover::after {
            content: "Esta entrega fue programada automáticamente al marcar 'Se pidió' en preventa";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #navegacion { 
            margin-bottom: 25px; 
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        #navegacion button {
            flex: 1;
            min-width: 180px;
            max-width: 220px;
        }
        #registroProveedores, #asistenciaDiaria, #reportes, #gestionProveedores { display: none; }
        .error { 
            color: #dc3545; 
            font-size: 0.9em; 
            margin-bottom: 15px; 
            min-height: 1.3em;
            font-weight: 500;
            padding: 5px 0;
        }
        .success-message {
            color: #28a745;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: 500;
            padding: 5px 0;
        }
        #gestionProveedores .datos-actions { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;}
        .asistencia-preventa-select { padding: 3px 6px; font-size: 0.85em; height: auto; max-width: 150px; vertical-align: middle; margin: 0; border-radius: 4px; border: 1px solid #ced4da; }
        .asistencia-container input[type="checkbox"] { vertical-align: middle; margin: 0; }

        /* Spinner y mensajes de carga */
        .spinner-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px 0;
        }
        .spinner {
            width: 28px;
            height: 28px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc3545;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .mensaje-carga {
            font-size: 1.1em;
            color: #495057;
            font-weight: 500;
        }

        /* MEJORAS RESPONSIVE */
        @media (max-width: 768px) {
            header h1 { font-size: 1.8em; }
            .main-container { width: 95%; margin: 15px auto; }
            #panel-conexion-carga, #panel-metricas { 
                width: 95%; 
                margin: 15px auto; 
                flex-direction: column; 
                gap: 15px; 
            }
            .metrica-box { flex: 1 1 100%; margin-bottom: 12px; }
            #navegacion { 
                flex-direction: column;
                gap: 8px;
            }
            #navegacion button { 
                width: 100%; 
                min-width: auto;
                max-width: none;
                margin-bottom: 8px; 
            }
            .seccion { padding: 20px 15px; }
            table { font-size: 0.8em; overflow-x: auto; }
            .asistencia-container { 
                flex-direction: column; 
                gap: 6px; 
            }
            .asistencia-preventa-select { 
                max-width: 140px; 
                font-size: 0.8em; 
            }
            button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            header { padding: 1rem 0; }
            header h1 { font-size: 1.5em; }
            .seccion { padding: 15px 12px; }
            .seccion h2 { font-size: 1.5em; }
            #panel-conexion-carga, #panel-metricas { margin: 10px auto; }
        }

        /* Mejorar feedback visual */
        .btn-success { background-color: #28a745 !important; }
        .btn-success:hover { background-color: #218838 !important; }
        
        .form-section { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .status-loading { opacity: 0.6; pointer-events: none; }
        
        /* Mejorar botones */
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important;
        }
        
        /* Mejorar tablas */
        table {
            border-collapse: collapse;
            margin-top: 20px;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
            font-size: 0.95em;
        }
        th {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            font-weight: 700;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85em;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.2s ease;
        }

        /* Modal sencillo para editar proveedor */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-card {
            background: white;
            width: min(720px, 95%);
            max-height: 90vh;
            overflow: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
        .modal-header h3 { margin:0; color:#dc3545; }
        .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    </style>
</head>
<body>

    <header>
        <h1>Abarrotes y Carniceria Itzel</h1>
    </header>

    <div id="panel-conexion-carga" style="width:90%;max-width:1200px;margin:15px auto 0 auto;display:flex;align-items:center;gap:20px;flex-wrap:wrap;padding:15px;background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
        <span id="backend-status-indicator" style="display:inline-block;padding:8px 20px;border-radius:8px;font-weight:700;background:#ffc107;color:#212529;font-size:0.95em;">
            ⏳ Verificando conexión con el backend...
        </span>
        <button id="btnRefrescarDatos" style="background:#007bff;color:white;border:none;border-radius:8px;padding:10px 20px;font-weight:600;cursor:pointer;font-size:0.9rem;">
            🔄 Refrescar datos
        </button>
        <div id="spinner-carga" class="spinner-container" style="display:none;">
            <div class="spinner"></div>
            <span class="mensaje-carga" id="mensaje-carga">Cargando proveedores...</span>
        </div>
    </div>

    <!-- Panel de métricas -->
    <div id="panel-metricas" style="width:90%;max-width:1200px;margin:20px auto 0 auto;display:flex;gap:20px;flex-wrap:wrap;">
        <div class="metrica-box" style="flex:1 1 200px;background:linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);border-radius:12px;padding:25px 20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);text-align:center;border:1px solid #f1c40f;">
            <div style="font-size:2.5em;font-weight:800;color:#856404;margin-bottom:5px;" id="metrica-activos">0</div>
            <div style="font-size:1em;color:#856404;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Proveedores activos</div>
        </div>
        <div class="metrica-box" style="flex:1 1 200px;background:linear-gradient(135deg, #d1ecf1 0%, #74b9ff 100%);border-radius:12px;padding:25px 20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);text-align:center;border:1px solid #3498db;">
            <div style="font-size:2.5em;font-weight:800;color:#0c5460;margin-bottom:5px;" id="metrica-ultimos">0</div>
            <div style="font-size:1em;color:#0c5460;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Visitas hoy</div>
        </div>
        <div class="metrica-box" style="flex:1 1 200px;background:linear-gradient(135deg, #f8d7da 0%, #fd79a8 100%);border-radius:12px;padding:25px 20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);text-align:center;border:1px solid #e84393;">
            <div style="font-size:2.5em;font-weight:800;color:#721c24;margin-bottom:5px;" id="metrica-actualizaciones">0</div>
            <div style="font-size:1em;color:#721c24;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Asistencias recientes</div>
        </div>
    </div>

    <div class="main-container">

        <div id="navegacion">
            <button id="btnRegistrar">Registrar Proveedores</button>
            <button id="btnAsistencia">Asistencia Diaria</button>
            <button id="btnVerGestionProveedores">Administrar Proveedores</button>
            <button id="btnReportes">Reportes</button>
        </div>

        <div id="registroProveedores" class="seccion">
            <h2>Registro de Proveedores</h2>
            <form id="proveedor-form">
                <div>
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" required>
                    <div class="error" id="error-nombre"></div>
                </div>
                <div>
                    <label>Frecuencia de visitas:</label>
                    <div id="patron-visita" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
                        <label><input type="radio" name="patronVisita" value="daily"> Diario</label>
                        <label><input type="radio" name="patronVisita" value="weekly" checked> Semanal (elige día/s)</label>
                        <div id="panel-semanal" style="margin-left:15px;display:flex;flex-wrap:wrap;gap:10px;">
                            <label><input type="checkbox" name="diasSemana" value="1"> Lunes</label>
                            <label><input type="checkbox" name="diasSemana" value="2"> Martes</label>
                            <label><input type="checkbox" name="diasSemana" value="3"> Miércoles</label>
                            <label><input type="checkbox" name="diasSemana" value="4"> Jueves</label>
                            <label><input type="checkbox" name="diasSemana" value="5"> Viernes</label>
                            <label><input type="checkbox" name="diasSemana" value="6"> Sábado</label>
                            <label><input type="checkbox" name="diasSemana" value="0"> Domingo</label>
                        </div>
                        <label><input type="radio" name="patronVisita" value="everyNDays"> Cada N días</label>
                        <div id="panel-cada-n" style="margin-left:15px;display:none;">
                            <input type="number" id="cada-n-dias" min="2" value="2" style="width:120px;"> días
                        </div>
                    </div>
                    <div class="error" id="error-dias-visita"></div>
                </div>
                <div>
                    <label for="fecha-inicio">Fecha Inicio (Cada X):</label>
                    <input type="date" id="fecha-inicio">
                    <div class="error" id="error-fecha-inicio"></div>
                </div>
                <div>
                    <label for="tipo-visita">Tipo Visita:</label>
                    <select id="tipo-visita" required>
                        <option value="">--</option>
                        <option>Visita Normal</option>
                        <option>Preventa</option>
                        <option>Entrega de Pedido</option>
                        <option>Otro</option>
                    </select>
                    <div class="error" id="error-tipo-visita"></div>
                </div>
                <button type="submit">Agregar Proveedor</button>
            </form>
        </div>

        <div id="asistenciaDiaria" class="seccion">
            <h2>Proveedores Esperados - <span id="fecha-hoy"></span></h2>
            <div style="margin-bottom:10px;display:flex;justify-content:flex-end;">
                <button id="toggleAsistenciaTools" style="background:#6c757d;">⚙️ Herramientas</button>
            </div>
            <div id="asistencia-tools" style="display:none;">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
                    <label>Fecha: <input type="date" id="asistenciaFecha"></label>
                    <label><input type="checkbox" id="autoRefreshChk"> Auto‑refrescar</label>
                    <select id="autoRefreshMins">
                        <option value="1">cada 1 min</option>
                        <option value="2" selected>cada 2 min</option>
                        <option value="5">cada 5 min</option>
                    </select>
                </div>
                <div id="asistencia-toolbar" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
                    <strong>Agregar visita manual para fecha seleccionada:</strong>
                    <select id="selectProveedorHoy" style="min-width:220px;"></select>
                    <select id="selectTipoHoy">
                        <option>Visita Normal</option>
                        <option>Preventa</option>
                        <option>Entrega de Pedido</option>
                        <option>Otro</option>
                    </select>
                    <button id="btnAgregarVisitaHoy" style="background:#17a2b8;">Agregar</button>
                    <span style="margin-left:10px;"><strong>Crear para TODOS:</strong></span>
                    <select id="selectTipoTodos">
                        <option>Visita Normal</option>
                        <option>Preventa</option>
                        <option>Entrega de Pedido</option>
                        <option>Otro</option>
                    </select>
                    <button id="btnCrearTodosFecha" style="background:#28a745;">Crear visitas (todos)</button>
                </div>
            </div>
            <div id="asistencia-empty" style="display:none;color:#6c757d;margin-bottom:8px;">No hay visitas programadas para esta fecha. Usa “Crear visitas (todos)” para generarlas o agrega una manualmente.</div>
            <table id="tabla-proveedores-hoy">
                <thead><tr><th>Nombre</th><th>Tipo</th><th>Asistió</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="gestionProveedores" class="seccion">
            <h2>Administrar Proveedores</h2>
            <div class="datos-actions">
                <p>Guarda o recupera todos los datos de la aplicación (proveedores y asistencias).</p>
                <button id="btnExportarDatos">Exportar Datos a Archivo</button>
                <button id="btnImportarDatos">Importar Datos desde Archivo</button>
                <input type="file" id="importFile" accept=".json,.txt" style="display: none;">
                <p><small>Al importar, los datos actuales se reemplazarán con los del archivo.</small></p>
            </div>
            <p>Aquí puedes ver todos tus proveedores registrados y eliminar o editar los que necesites.</p>
            <table id="tablaGestionProveedores">
                <thead><tr><th>Nombre</th><th>Días Visita</th><th>Tipo</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Modal de Edición de Proveedor -->
        <div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
            <div class="modal-card">
                <div class="modal-header">
                    <h3 id="editModalTitle">Editar Proveedor</h3>
                    <button id="editCloseBtn" title="Cerrar" style="background:#6c757d;">✖</button>
                </div>
                <div id="edit-error" class="error"></div>
                <div class="form-section">
                    <label for="edit-nombre">Nombre:</label>
                    <input type="text" id="edit-nombre">
                </div>
                <div class="form-section">
                    <label>Frecuencia de visitas:</label>
                    <div id="edit-patron-visita" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
                        <label><input type="radio" name="editPatronVisita" value="daily"> Diario</label>
                        <label><input type="radio" name="editPatronVisita" value="weekly"> Semanal (elige día/s)</label>
                        <div id="edit-panel-semanal" style="margin-left:15px;display:flex;flex-wrap:wrap;gap:10px;">
                            <label><input type="checkbox" name="editDiasSemana" value="1"> Lunes</label>
                            <label><input type="checkbox" name="editDiasSemana" value="2"> Martes</label>
                            <label><input type="checkbox" name="editDiasSemana" value="3"> Miércoles</label>
                            <label><input type="checkbox" name="editDiasSemana" value="4"> Jueves</label>
                            <label><input type="checkbox" name="editDiasSemana" value="5"> Viernes</label>
                            <label><input type="checkbox" name="editDiasSemana" value="6"> Sábado</label>
                            <label><input type="checkbox" name="editDiasSemana" value="0"> Domingo</label>
                        </div>
                        <label><input type="radio" name="editPatronVisita" value="everyNDays"> Cada N días</label>
                        <div id="edit-panel-cada-n" style="margin-left:15px;display:none;">
                            <input type="number" id="edit-cada-n-dias" min="2" value="2" style="width:120px;"> días
                        </div>
                    </div>
                    <div>
                        <label for="edit-fecha-inicio">Fecha Inicio (Cada X):</label>
                        <input type="date" id="edit-fecha-inicio">
                    </div>
                    <div>
                        <label for="edit-tipo-visita">Tipo Visita:</label>
                        <select id="edit-tipo-visita">
                            <option value="">--</option>
                            <option>Visita Normal</option>
                            <option>Preventa</option>
                            <option>Entrega de Pedido</option>
                            <option>Otro</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="editSaveBtn" style="background:#28a745;">Guardar</button>
                    <button id="editCancelBtn" style="background:#6c757d;">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="reportes" class="seccion">
            <h2>Reportes de Asistencia</h2>
            <div id="botonesReportesPredefinidos">
                <button id="btnReporteUltimos3Dias">Últimos 3 Días</button>
                <button id="btnReporteUltimos5Dias">Últimos 5 Días</button>
                <button id="btnReporteUltimos7Dias">Últimos 7 Días</button>
                <button id="btnReporteUltimos15Dias">Últimos 15 Días</button>
                <button id="btnReporteUltimoMes">Último Mes</button>
            </div>
            <div id="reportePersonalizado" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>Reporte Personalizado</h3>
                <label for="fechaInicioReporte">Fecha de Inicio:</label><input type="date" id="fechaInicioReporte">
                <label for="fechaFinReporte">Fecha de Fin:</label><input type="date" id="fechaFinReporte">
                <button id="btnGenerarReportePersonalizado">Generar Reporte</button>
            </div>
            <div id="errorReporte" class="error"></div>
            <div id="tablaReporte"></div>
            <button id="btnExportarReporteCSV">Exportar Tabla a CSV</button>
        </div>

    </div>

    <script type="module" src="./assets/js/app.js"></script>
</body>
</html>
